#!/bin/env python3

import re
import subprocess
import time

BUTTON_PIN = 23
OVERRIDE_PIN = 12


def get_pin_state(pin: int) -> bool:
    p = subprocess.run(["pinctrl", "get", str(pin)], capture_output=True, text=True)
    if p.returncode != 0:
        print("Failed to run pinctrl")
        return True
    if not p.stdout:
        print("No output from pinctrl")
        return True
    m = re.search(r"\| (hi|lo) //", p.stdout)
    if m is None:
        print(f"Parsing error! string = {p.stdout}")
        return True
    return False if m.group(1) == "lo" else True


state = True

while True:
    time.sleep(2)
    bs = get_pin_state(BUTTON_PIN)
    os = get_pin_state(OVERRIDE_PIN)
    s = bs or os
    if s == state:
        continue
    else:
        if s:
            subprocess.run(["xset", "-dpms"], check=True)
        else:
            subprocess.run(["xset", "dpms", "force", "suspend"], check=True)
        state = s
